version: 2.1

jobs:
  test:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run: |
          curl -sL https://deb.nodesource.com/setup_14.x -o /tmp/nodesource_setup.sh
          sudo bash /tmp/nodesource_setup.sh
          sudo apt install -y nodejs
      - run: |
          mkdir ~/$KUBE_REPO
          git clone git@github.com:MikeZ77/$KUBE_REPO.git ~/$KUBE_REPO
          cp ~/$KUBE_REPO/.env .
      - run: |
          ls -lrt
          cat .env
      - run: npm install
      - run: docker-compose up
      - run: | 
          docker cp ~/$KUBE_REPO/app.bak sql-server:/tmp
          docker cp ~/$KUBE_REPO/restore_app.sql sql-server:/tmp
          docker exec sql-server /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P dev7aY\!dm2t62 -i /tmp/restore_app.sql
      - run: npm run test
  build:
    docker:
      - image: docker:stable
    steps:
      - checkout
      - setup_remote_docker
      - run: docker build --tag mzaghi/coffee-chess:lab .
      - run: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run: docker push mzaghi/coffee-chess:lab

  # deploy:
  #   requires:
  #     - build

workflows:
  test_build_deploy:
    jobs:
      - test
      - build:
          requires:
            - test